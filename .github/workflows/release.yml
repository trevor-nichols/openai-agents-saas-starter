name: Release

on:
  push:
    tags:
      - "v*"

jobs:
  build-and-publish:
    runs-on: ubuntu-latest
    permissions:
      contents: write
      id-token: write
      attestations: write
    env:
      STARTER_CONSOLE_SKIP_ENV: "true"
      STARTER_CONSOLE_SKIP_VAULT_PROBE: "true"
    steps:
      - name: Check out repository
        uses: actions/checkout@v4

      - name: Install just
        run: |
          sudo apt-get update
          sudo apt-get install -y just

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      - name: Enable Corepack / pnpm
        run: |
          corepack enable
          corepack prepare pnpm@10.15.0 --activate

      - name: Install Hatch and tooling
        run: |
          python -m pip install --upgrade pip
          pip install hatch pip-audit cyclonedx-bom

      - name: Build wheel artifacts
        run: |
          rm -rf dist
          mkdir -p dist
          for pkg in starter_contracts starter_console starter_providers; do
            rm -rf "packages/${pkg}/dist"
            (cd "packages/${pkg}" && hatch build -t wheel)
            cp "packages/${pkg}/dist/"*.whl dist/
          done

      - name: Python SBOMs (pip-audit)
        run: |
          set -euo pipefail
          for pkg in starter_contracts starter_console starter_providers; do
            venv_dir="$(mktemp -d)"
            python -m venv "${venv_dir}/venv"
            source "${venv_dir}/venv/bin/activate"
            python -m pip install --upgrade pip pip-audit
            if [ "${pkg}" = "starter_console" ]; then
              python -m pip install dist/starter_contracts-*.whl dist/starter_providers-*.whl
            fi
            python -m pip install "dist/${pkg}-"*.whl
            pip-audit --progress-spinner off --format cyclonedx-json --output "${pkg}-sbom.json"
            deactivate
            rm -rf "${venv_dir}"
          done

      - name: Install frontend dependencies
        working-directory: apps/web-app
        run: pnpm install --frozen-lockfile

      - name: Node dependency audit
        working-directory: apps/web-app
        run: pnpm audit --audit-level=high

      - name: Node SBOM (CycloneDX)
        working-directory: apps/web-app
        run: pnpm dlx @cyclonedx/cdxgen -o ../../frontend-sbom.json -t javascript --no-analytics

      - name: Attest build provenance
        uses: actions/attest-build-provenance@v1
        with:
          subject-path: |
            dist/*.whl
            starter_contracts-sbom.json
            starter_console-sbom.json
            starter_providers-sbom.json
            frontend-sbom.json

      - name: Publish GitHub Release assets
        uses: softprops/action-gh-release@v2
        with:
          files: |
            dist/*.whl
            starter_contracts-sbom.json
            starter_console-sbom.json
            starter_providers-sbom.json
            frontend-sbom.json
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
