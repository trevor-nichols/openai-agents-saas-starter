## Backend Issue Tracker

| ID | Title | Description | Status | Owner | Notes |
|----|-------|-------------|--------|-------|-------|
| BE-001 | SSE stream endpoint mismatch | Frontend streams against `/api/v1/agents/chat/stream` while FastAPI exposes `/api/v1/chat/stream`, breaking real-time updates. | Resolved | – | Frontend + smoke test now target `/api/v1/chat/stream`. |
| BE-002 | Conversation history is in-memory only | `InMemoryConversationRepository` is the default and no durable adapter exists, so conversations evaporate on restart / multi-instance deploys. | In Progress | – | Postgres repository wired via `use_in_memory_repo=false`; need migration-powered rollout + durability tests. |
| BE-003 | Tool registry lacks agent-specific scoping | `ToolRegistry.get_core_tools()` returns the same tool set for every agent, preventing specialization as catalog grows. | Open | – | Extend registry to support per-agent tool bundles and metadata-driven assignment. |
| BE-004 | Authentication is demo-only | `/api/v1/auth` hard-codes demo credentials and issues JWTs without user store or hashing pipeline. | Open | – | Replace with real identity provider or disable in prod builds. |
| BE-005 | Multi-agent handoff not configured | `AgentRegistry` provisions specialized agents but never wires `handoffs`, so triage cannot delegate per SDK guidance. | Resolved | – | Triage agent now uses SDK `handoff(...)` with prompt helper and descriptions. |
| DB-001 | Durable conversation schema & migrations | Introduce SQLAlchemy models plus Alembic migration for Postgres conversation/billing tables. | In Progress | – | Alembic scaffold + baseline migration `20251106_120000`; CI smoke tests exercise upgrade/downgrade on Postgres. |
| DB-002 | Async engine bootstrap & configuration | Add Postgres engine/session factory, settings, startup validation, and local tooling support. | In Progress | – | Async engine + health check implemented; document Docker workflow and production toggles. |
| DB-003 | Conversation repository integration | Implement Postgres-backed repository, wire into agent service, and update tests/tooling. | In Progress | – | Repository live with CI coverage (`tests/integration/test_postgres_migrations.py`); next: metrics + retention hooks. |
| BILL-001 | Billing service & API scaffolding | Deliver tenant-scoped billing commands (start/update/cancel/usage) with role guards and Stripe-ready hooks. | In Progress | – | Endpoints exposed under `/api/v1/billing`, Postgres repository & gateway stubs implemented; pending Stripe integration & webhook handling. |
| AUTH-001 | Threat model & auth requirements | Document JWT consumers, threat boundaries, and approve Ed25519 rollout scope. | Planned | – | Output feeds milestone kickoff doc and security review checklist. |
| AUTH-002 | Ed25519 key management service | Implement key lifecycle module, secure storage contract, and rotation playbooks. | In Progress | – | Key lifecycle module, Vault KV adapter, refresh-token repository, and Alembic migration `20251106_220000_*` landed; Redis cache wired for reuse from `AuthService`. Remaining: finalize rotation runbook approvals and stage dual-key smoke tests. |
| AUTH-003 | JWT service refactor | Swap PyJWT to EdDSA signer/validator with strict claim schema and pluggable backends. | In Progress | – | Must ship unit/contract tests covering positive/negative paths.<br>**Nonce cache decision:** reuse the Redis revocation cluster with a dedicated prefix (`auth:nonce:*`) and max TTL 5 min; ops to allocate per-environment namespaces plus dashboarding alongside revocation metrics. Document fallback to in-memory cache for local/dev-only.<br>**Storage hardening:** `service_account_tokens.refresh_token_hash` now stores bcrypt(+pepper) digests using `AUTH_REFRESH_TOKEN_PEPPER`, truncating legacy plaintext rows via migration `20251106_230500` (satisfies threat-model R10).<br>**Signer refactor:** `TokenSigner`/`TokenVerifier` now wrap Ed25519 key material from `KeySet`, `auth_dual_signing_enabled`/`AUTH_DUAL_SIGNING_OVERLAP_MINUTES` govern dual signing, and refresh tokens persist `signing_kid` (`migration 20251106_235500`) so reuse + revocation rehydrate the correct JWS. Unit + contract suites cover tampering, unknown `kid`, and expiry paths.<br>**Migration status:** Revisions `20251106_230500` + `20251106_235500` are applied in all envs; legacy refresh tokens reissued post-cutover with the peppered hash requirement in place.<br>**Acceptance criteria:**<br>1. `TokenSigner`/`TokenVerifier` implementations issue/validate EdDSA tokens backed by `KeySet` with strict `iss/aud/sub/jti` enforcement.<br>2. `/api/v1/auth` + AuthService responses advertise the active EdDSA `kid`, reject HS256 tokens, and persist revocations via the new repository.<br>3. Contract + unit tests cover success, expired/replayed tokens, and rotated-key scenarios, running in CI with coverage ≥90% for `app/core/security.py`. |
| AUTH-004 | JWKS publishing endpoint | Expose active/next public keys, add caching headers, and verify Next.js consumption. | In Progress | – | JWKS responder now serves only active/next keys, attaches `Cache-Control`, strong `ETag`, and `Last-Modified`, and returns 304s when `If-None-Match` matches. `KeySet.materialize_jwks()` caches DTOs until kids/schema change, settings gained `AUTH_JWKS_MAX_AGE_SECONDS` + `AUTH_JWKS_ETAG_SALT`, and `auth jwks print` CLI command plus Prom counters (`jwks_requests_total`, `jwks_not_modified_total`) shipped. Contract tests cover 200/304 flows; docs updated so consumers poll ≤max-age and honor ETags. |
| AUTH-005 | Auth observability & alerts | Instrument structured logs, metrics, and alerts on token failures/rotation drift. | In Progress | – | TokenSigner/Verifier + service-account issuance now emit Prometheus counters/histograms (`jwt_*`, `service_account_issuance_*`, nonce hit/miss) exposed at `/metrics`; structured JSON logs stream via `auth.observability` covering sign/verify, rate limits, Vault events, and docs capture alert thresholds (1% verification failures → PagerDuty, issuance p95 >2s → Slack). Dashboard wiring + PagerDuty automation pending. |
| AUTH-006 | Staged rollout & postmortem | Run dual-signing canary, monitor, cutover to EdDSA-only, and capture lessons. | Planned | – | Requires coordination with QA and ops for validation sign-off. |
| IDP-001 | Human auth requirements & threat model | Document user lifecycle, password policy, lockouts, auditing fields, and external IdP compatibility. | Completed | – | Approved 2025-11-07: `docs/auth/idp.md` + `docs/security/auth-threat-model.md` baseline downstream scope; handoff to IDP-002. |
| IDP-002 | User data model & migrations | Ship Alembic migration for `users`, `user_profiles`, `user_login_events`, plus seed tooling. | Completed | – | Migration `0e52ba5ab089` applied (make migrate) with ORM models + seed utility; docs/env updated 2025-11-07. |
| IDP-003 | User domain & service layer | Implement `UserRepository`/`UserService`, lockout helpers, bcrypt+pepper hashing, and extend `AuthService` for user login/refresh. | Planned | – | Owner: Backend Auth. Exit: ≥90% unit test coverage, lint/type checks clean, Redis lockout counters wired. |
| IDP-004 | Auth API & contract updates | Replace demo `/auth/token` with service-backed login, add register/reset stubs, ensure responses carry token metadata + RBAC context. | Planned | – | Owner: Backend Auth. Exit: Contract tests (login, bad password, locked account, refresh, revoked token) green; OpenAPI regenerated. |
| IDP-005 | Frontend login UX | Update Next.js frontend with real login/logout, secure cookie storage, silent refresh, and protected routes. | Planned | – | Owner: Frontend Web. Exit: build/tests green, UX reviewed, Playwright smoke verifies login + refresh. |
| IDP-006 | Rollout, docs, & feature flagging | Provide `AUTH_IDP_MODE` flag, runbook, and documentation so adopters can toggle between demo and internal auth flows. | Planned | – | Owner: Backend Auth + Ops. Exit: flag default set, docs updated, retrospective logged. |
