# Ensure we always run with the project virtualenv, not Homebrew/pyenv shims.
# Requires direnv (https://direnv.net/). Run `direnv allow` in this folder once.

set -e

VENV_DIR="${PWD}/.venv"

if [ ! -d "$VENV_DIR" ]; then
  echo "missing .venv; run 'hatch env create' from apps/api-service" >&2
  exit 1
fi

# Activate the project-local virtualenv and fail fast if it is not used.
source "$VENV_DIR/bin/activate"

python - <<'PY'
import sys
from pathlib import Path

exe = Path(sys.executable)
if ".venv" not in exe.parts:
    raise SystemExit(f"ERROR: expected interpreter from .venv, got {exe}")
PY
