## Backend Issue Tracker

| ID | Title | Description | Status | Owner | Notes |
|----|-------|-------------|--------|-------|-------|
| BE-001 | SSE stream endpoint mismatch | Frontend streams against `/api/v1/agents/chat/stream` while FastAPI exposes `/api/v1/chat/stream`, breaking real-time updates. | Resolved | *@codex* | Frontend + smoke test now target `/api/v1/chat/stream`. |
| BE-002 | Conversation history lacked durable storage | Conversation history now persists via Postgres-backed repositories, and the legacy in-memory adapter/flag have been removed. | Completed | *@codex* | `.env.compose` ships `DATABASE_URL`, the FastAPI lifespan always boots the async engine, and readiness probes fail fast if Postgres is unavailable. |
| BE-003 | Tool registry lacks agent-specific scoping | `ToolRegistry.get_core_tools()` returns the same tool set for every agent, preventing specialization as catalog grows. | Resolved | *@codex* | Tool metadata now tracks `core`, `agents`, and `capabilities`, `get_tools_for_agent()` filters by that metadata, AgentRegistry requests scoped tool lists, tests/docs updated. |
| BE-004 | Authentication is demo-only | `/api/v1/auth` hard-codes demo credentials and issues JWTs without user store or hashing pipeline. | Resolved | *@codex* | FastAPI now backs `/api/v1/auth/*` with the new user/service-account pipeline (Postgres users, bcrypt+pepper hashing, EdDSA tokens, contract tests). |
| BE-005 | Multi-agent handoff not configured | `AgentRegistry` provisions specialized agents but never wires `handoffs`, so triage cannot delegate per SDK guidance. | Resolved | *@codex* | Triage agent now uses SDK `handoff(...)` with prompt helper and descriptions. |
| BE-006 | Signup trial override bypass | `/auth/register` forwarded client-supplied `trial_days` directly to Stripe, allowing arbitrarily long free trials. | Resolved | *@codex* | SignupService now derives trial length from plan metadata/defaults and only honors overrides when `allow_signup_trial_override=true`; unit tests and settings docs updated. |
| DB-001 | Durable conversation schema & migrations | Introduce SQLAlchemy models plus Alembic migration for Postgres conversation/billing tables. | Completed | *@codex* | Alembic scaffold + baseline migration `20251106_120000`; CI smoke tests exercise upgrade/downgrade on Postgres. |
| DB-002 | Async engine bootstrap & configuration | Add Postgres engine/session factory, settings, startup validation, and local tooling support. | Completed | *@codex* | Async engine + health check implemented; document Docker workflow and production toggles shipped with Make targets + Compose helpers. Default tests now pin `DATABASE_URL` to SQLite and require `USE_REAL_POSTGRES=true` before hitting live Postgres. |
| DB-003 | Conversation repository integration | Implement Postgres-backed repository, wire into agent service, and update tests/tooling. | Completed | *@codex* | Repository live with CI coverage (`tests/integration/test_postgres_migrations.py`); retention hooks tracked separately. |
| DB-004 | Agents SDK session integration | Align AgentService with OpenAI Agents SDK session/memory so chat history persists via session tokens. | Completed | *@codex* | `agent_conversations` now tracks `sdk_session_id` + sync metadata, the FastAPI lifespan wires the shared SQLAlchemy session store, AgentService runs chats with SDK sessions, and integration tests cover session persistence across restarts. |
| DB-005 | Billing service scaffold | Ship plan catalog, subscription lifecycle, usage recording, and tests over the Postgres repository. | Completed | *@codex* | `BillingService` drives `/api/v1/billing/*`, backed by `PostgresBillingRepository` + Stripe gateway stubs, with comprehensive unit coverage. |
| DB-006 | API & health hardening | Expose database-aware readiness probes, update docs, and ensure Compose defaults include Postgres settings. | Completed | *@codex* | `/health/ready` now calls `verify_database_connection()`, `.env*` ship `DATABASE_URL`, and docs describe failure modes + setup flow. |
| BILL-001 | Billing service & API scaffolding | Deliver tenant-scoped billing commands (start/update/cancel/usage) with role guards and Stripe-ready hooks. | Completed | *@codex* | Backend + frontend now cover dispatcher orchestration, Redis/SSE payloads, retry tooling, verification suites (`make test-stripe`, CLI replay integration test), and runbooks/metrics so operators can replay or monitor billing flows without touching live Stripe. |
| AUTH-001 | Threat model & auth requirements | Document JWT consumers, threat boundaries, and approve Ed25519 rollout scope. | Completed | *@codex* | Approved via `docs/auth/idp.md` + `docs/security/auth-threat-model.md`; feeds milestone kickoff doc and security review checklist. |
| AUTH-002 | Ed25519 key management service | Implement key lifecycle module, secure storage contract, and rotation playbooks. | Completed | *@codex* | Simplified single-key storage backed by file/Vault adapters plus the `auth keys rotate` helper (replaces the active key in place). JWKS endpoint and CLI tooling verified 2025-11-07. |
| AUTH-003 | JWT service refactor | Swap PyJWT to EdDSA signer/validator with strict claim schema and pluggable backends. | Completed | *@codex* | **Nonce cache decision:** reuse the Redis revocation cluster with a dedicated prefix (`auth:nonce:*`) and max TTL 5 min; no local in-process fallback remains.<br>**Storage hardening:** `service_account_tokens.refresh_token_hash` now stores bcrypt(+pepper) digests using `AUTH_REFRESH_TOKEN_PEPPER`, truncating legacy plaintext rows via migration `20251106_230500` (satisfies threat-model R10).<br>**Signer refactor:** `TokenSigner`/`TokenVerifier` now wrap the active Ed25519 key from `KeySet`, and refresh tokens persist `signing_kid` (`migration 20251106_235500`) so reuse + revocation rehydrate the correct JWS. Contract + unit suites cover tampering, unknown `kid`, and expiry paths; coverage gate met. |
| AUTH-004 | Self-serve signup & trial onboarding | Add `/auth/register`, tenant bootstrap, and default free/trial plan provisioning so new tenants can create accounts without manual scripts. | Completed | *@codex* | `/auth/register` now enforces per-IP quotas, provisions tenants via the new `SignupService`, and returns a session + tenant slug. Config adds signup toggles + defaults, tenant persistence wraps Postgres, and unit tests cover slug collisions + billing hooks. |
| AUTH-004 | JWKS publishing endpoint | Expose active/next public keys, add caching headers, and verify Next.js consumption. | Completed | *@codex* | JWKS responder now serves only active/next keys, attaches `Cache-Control`, strong `ETag`, and `Last-Modified`, and returns 304s when `If-None-Match` matches. `KeySet.materialize_jwks()` caches DTOs until kids/schema change, settings gained `AUTH_JWKS_MAX_AGE_SECONDS` + `AUTH_JWKS_ETAG_SALT`, and `auth jwks print` CLI command plus Prom counters (`jwks_requests_total`, `jwks_not_modified_total`) shipped. Contract tests cover 200/304 flows; docs updated so consumers poll ≤max-age and honor ETags. |
| AUTH-005 | Auth observability & alerts | Instrument structured logs, metrics, and alerts on token failures/rotation drift. | Removed | *@codex* | Starter scope stops at exposing `/metrics` plus structured logs; Slack/PagerDuty automation dropped as out-of-scope polish. |
| AUTH-006 | Staged rollout & postmortem | Run dual-signing canary, monitor, cutover to EdDSA-only, and capture lessons. | Removed | *@codex* | No staged rollout required before the codebase is public; treat as future ops checklist if production environments emerge. |
| IDP-001 | Human auth requirements & threat model | Document user lifecycle, password policy, lockouts, auditing fields, and external IdP compatibility. | Completed | *@codex* | Approved 2025-11-07: `docs/auth/idp.md` + `docs/security/auth-threat-model.md` baseline downstream scope; handoff to IDP-002. |
| IDP-002 | User data model & migrations | Ship Alembic migration for `users`, `user_profiles`, `user_login_events`, plus seed tooling. | Completed | *@codex* | Migration `0e52ba5ab089` applied (make migrate) with ORM models + seed utility; docs/env updated 2025-11-07. |
| IDP-003 | User domain & service layer | Implement `UserRepository`/`UserService`, lockout helpers, bcrypt+pepper hashing, and extend `AuthService` for user login/refresh. | Completed | *@codex* | Repository + service stack merged with Redis-backed lockouts, bcrypt+pepper hashing, and comprehensive unit tests; CI coverage gate met. |
| IDP-004 | Auth API & contract updates | Replace demo `/auth/token` with service-backed login, add register/reset stubs, ensure responses carry token metadata + RBAC context. | Completed | *@codex* | `/api/v1/auth` login/refresh now call the new services, user metadata exposed via `/auth/me`, refresh rotation enforced, and contract suite `tests/contract/test_auth_users.py` green; OpenAPI regenerated. |
| IDP-005 | Frontend login UX | Update Next.js frontend with real login/logout, secure cookie storage, silent refresh, and protected routes. | Completed | *@codex* | Login page, server actions, secure cookie helpers, middleware guard, silent refresh hook, and Playwright smoke test landed in `agent-next-15-frontend`. |
| STRIPE-01 | Settings & Secrets Baseline | Add Stripe config fields, env docs, and startup guards so billing can’t boot without credentials. | Completed | *@codex* | FastAPI lifespan now enforces Stripe env vars when `ENABLE_BILLING=true`, logs masked `stripe_config` summaries, and `docs/billing/stripe-setup.md` includes the troubleshooting matrix + log samples. |
| STRIPE-02 | Developer Setup Script | Build `scripts/stripe/setup.py` (CLI checks, Postgres helper, env writers) modeled after the reference script lines 33‑320; include an "easy setup" action that opens Stripe’s guided install/auth page before continuing. | Completed | *@codex* | Flow now lives under `python -m anything_agents.cli stripe setup` (aliased via `pnpm stripe:setup`), provisioning Starter/Pro plans, recording `STRIPE_SECRET_KEY`/`STRIPE_WEBHOOK_SECRET`/`STRIPE_PRODUCT_PRICE_MAP`, and documenting the runbook in `docs/scripts/stripe-setup.md`. |
| STRIPE-03 | Stripe Gateway Implementation | Replace stubbed `StripeGateway` with full customer/subscription/usage calls plus retries and observability. | Completed | *@codex* | Gateway now wraps the typed Stripe client with structured logs, Prom counters/histograms, domain error codes, and unit tests covering metrics + usage/idempotency flows; see `app/services/payment_gateway.py`, `app/observability/metrics.py`, and `tests/unit/test_stripe_gateway.py`. |
| STRIPE-04 | Webhook Intake & Event Store | Add FastAPI webhook endpoint, event tables, signature verification, and reconciliation flows; persist every Stripe event type even if only some update state today. | Completed | *@codex* | Shipping the `stripe_event_dispatch` table + Alembic revision, dispatcher service, webhook wiring, replay CLI overhaul, and BillingService sync entrypoints so webhook → domain updates are auditable and replayable. |
| STRIPE-05 | Real-Time Billing Stream | Implement Redis-backed broadcaster + WebSocket/SSE endpoints and wire the Next.js dashboard to consume updates. | Completed | *@codex* | Redis stream publisher, SSE endpoint (+ rate limiting) and frontend listeners are live; integration/unit suites cover replay + SSE flows. |
| STRIPE-06 | Test & Ops Tooling | Add automated tests, fixture replay harness, CLI docs, and runbooks for Stripe key rotation + webhook replay. | Completed | *@codex* | `make test-stripe`, replay CLI, fixture linting, and the updated runbook (now with the Stripe Secret Rotation SOP) document ops + verification steps. |
| AUTH-004 | Protect public chat/catalog APIs | `/api/v1/chat`, `/api/v1/chat/stream`, `/api/v1/agents`, `/api/v1/conversations`, and `/api/v1/tools` skip `require_current_user`, so anonymous users can burn GPT-5 quota. | Completed | *@codex* | Shared `require_scopes` dependency + updated routers/tests now enforce JWT scopes (`conversations:*`, `tools:read`, `conversations:delete`) so anonymous or under-scoped callers are rejected. |
| AUTH-005 | Password reset endpoints & history enforcement | Deliver `/auth/password/change` + `/auth/password/reset` backed by password history checks, audit events, and refresh-token revocation. | Completed | *@codex* | FastAPI endpoints, service/repository plumbing, and contract/unit tests merged 2025-11-09; docs + CLI updated. |
| AUTH-006 | Central password policy & IP guardrail | Enforce 14+ char, multi-class, zxcvbn≥3 policy everywhere and throttle abusive /24s via Redis counters. | Completed | *@codex* | New `password_policy` helper, Signup/User services, CLI, and docs updated; Redis-backed IP lockouts wired with metrics/logs and configurable `AUTH_IP_LOCKOUT_*` settings. |
| AUTH-007 | Logout endpoint & server revocation | Add `/auth/logout` (single refresh token) and `/auth/logout/all` (device sweep) so clients can explicitly revoke sessions server-side instead of relying on local token drops. | Completed | *@codex* | Added AuthService `logout_user_session` (verifies ownership, accepts expired tokens, logs audit events) plus FastAPI routes with contract + unit tests; responses return revoke counts so the frontend can surface accurate UX copy. |
| AUTH-008 | Self-serve password recovery | Provide `/auth/password/forgot` + `/auth/password/confirm` that issue signed reset tokens via email and enforce password policy/history when redeemed. | Completed | *@codex* | Redis-backed reset token store, rate-limited request endpoint, confirmation route calling UserService + session revocation, notifier stub, unit/contract tests, and new config knobs (TTL + peppers). |
| AUTH-009 | Email verification lifecycle | Implement `/auth/email/send` and `/auth/email/verify` so new users must confirm ownership before accessing protected routes, with resend throttles and audit trails. | Completed | *@codex* | Added Redis token store + service, signup auto-sends verification, new endpoints with rate limits, JWT/session payload includes `email_verified`, and chat/billing/tooling routes now enforce the verified dependency. |
| AUTH-010 | Session/device management API | Surface `/auth/sessions` (list) and `/auth/sessions/{id}` (revoke) so users can audit active devices, locations, and last activity. | Completed | *@codex* | Added `user_sessions` table + crypto hashing, AuthService now tracks multi-device refresh tokens, FastAPI exposes list/delete endpoints, and responses include stable `session_id` for the frontend sidebar. |
| TENANT-001 | Stop trusting `X-Tenant-Id` header | Billing routes only compare the header to the URL path; callers can spoof another tenant without matching JWT claims. | Completed | *@codex* | `get_tenant_context` now derives tenant + role from JWT claims, rejects mismatched headers, and maps scopes to `TenantRole`; billing routers consume the secured context. |
| BILL-002 | Stripe worker/billing stream multi-pod safety | Every FastAPI replica starts a retry worker and Redis billing stream publisher, so multi-replica deployments will double-handle events. | Completed | *@codex* | Added `ENABLE_BILLING_RETRY_WORKER` + `ENABLE_BILLING_STREAM_REPLAY` toggles, lifespan guards, and doc guidance so only designated pods run the background workers. |
| OPS-001 | Secret management guidance | README/env defaults still ship dev `SECRET_KEY`, peppers, Vault placeholders, and Redis URLs; easy to forget before launch. | Completed | *@codex* | Added `.env.local.example`, runtime guardrails, and `scripts/check_secrets.py` so production builds fail fast when defaults are present. |
| OPS-002 | Abuse/rate limiting on chat & SSE | Even after auth, chat endpoints and billing SSE streams have no throttling or audit trail. | Completed | *@codex* | Redis-backed rate limiter now guards chat + billing SSE (per-user & per-tenant quotas, concurrency caps, metrics, and structured `rate_limit.block` logs); docs/env defaults call out the new settings. |
| BE-011 | Host + CORS hardening | Trusted-host middleware still allows `*` in prod and SSE responses ship permissive CORS headers, so any domain can hit the API. | Completed | *@codex* | FastAPI now reads `ALLOWED_HOSTS`/`ALLOWED_ORIGINS` env vars with localhost defaults, TrustedHost + CORS middleware share the parsed settings, and env templates document the knobs pending CLI automation. |
| SEC-007 | Replace starter secrets & move keysets to Vault | Default peppers/secret key/keyset live in repo and `auth_key_storage_backend` remains `file`. | Open | *@codex* | Starter documents the defaults; CLI will later offer “bring your own Vault” to rotate secrets. No additional backend change required now. |
| SEC-008 | Enforce Vault-signed service-account requests | `/auth/service-accounts/issue` still relies on `dev-local` fallback because Vault Transit isn’t configured. | Open | *@codex* | Leave dev-local path for the starter; CLI/docs explain how to enable Transit when a deployment has Vault handy. |
| OPS-003 | Third-party env parity (Stripe/Resend/Tavily) | Billing/email/search features only log warnings when provider keys or plan maps are missing. | Open | *@codex* | Repo-root CLI wizard (`python -m anything_agents.cli setup wizard`) now captures Stripe/Resend/OpenAI/Tavily secrets and writes env files; remaining scope is enforcing optional providers in CI + documenting advanced observability sinks. |
| INFRA-004 | Production-grade Redis | Rate limiting, billing streams, lockout counters, and nonce stores all share a single unauthenticated Redis URL. | Open | *@codex* | Starter keeps local Redis; CLI/docs will guide users to provision managed Redis (auth/TLS, isolated DBs) for real deployments. |
| DB-007 | Release playbook for migrations & plan seeding | `auto_run_migrations` is disabled in prod, but there’s no documented CI/CD step to run Alembic + seed billing plans. | Open | *@codex* | Address via CLI workflow (`make migrate`, plan seeding script) and accompanying docs—no additional backend work planned. |
| BE-012 | Tenant attribution for conversations | When metadata omits `tenant_id`, persistence falls back to a shared “default” tenant, risking cross-tenant leakage. | Open | *@codex* | Contracts already expect tenant IDs; document this in the CLI-generated config and consider adding validation during CLI scaffolding. |
| OBS-006 | Centralized structured logging | Request/Stripe/auth events log locally but there’s no sink or JSON formatter for correlation IDs, rate-limit hits, etc. | Open | *@codex* | Starter sticks with stdout logging; CLI/docs will explain how to enable JSON formatting or forward logs to Datadog/ELK. |
| AUTH-011 | Public signup policy & throttling review | `allow_public_signup` defaults true and quotas are best-effort; risk of bot-created tenants. | Open | *@codex* | Default remains enabled; CLI will let users toggle signup mode (public/invite-only) and set stronger quotas during setup. |
| OBS-007 | GeoIP + session telemetry | Session records include GeoIP fields but the service is a no-op, so device history shows “unknown”. | Open | *@codex* | Leave the NullGeoIP implementation; document how to plug in a paid provider and wire API keys via CLI. |
| OPS-004 | Stripe retry worker scaling | Each FastAPI pod can still run the retry worker when `ENABLE_BILLING_RETRY_WORKER=true`, complicating horizontal scaling. | Open | *@codex* | CLI/docs will instruct users to run exactly one worker (or a dedicated deployment) when scaling; no code change needed. |
