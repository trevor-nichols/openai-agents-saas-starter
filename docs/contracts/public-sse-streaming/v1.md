# Public SSE Streaming Contract — v1

_Last updated: 2025-12-15_  
**Status:** Locked for implementation (P1)  
**Applies to:** Browser-facing SSE streams (chat + workflows) via the Next.js BFF.

## 1) Purpose

Define the **authoritative, browser-safe** streaming contract for real-time UX:

OpenAI Responses streaming events → Agents SDK → API service normalization → **Public SSE Contract (this doc)** → SSE → Next.js BFF → browser parsing + UI.

This contract is:
- **Provider-neutral**: UI does not depend on OpenAI raw event shapes.
- **Derived-only**: no raw provider payloads are forwarded to browsers.
- **Deterministic**: explicit terminal semantics, stable identifiers, and testable invariants.
- **UX-oriented**: typed tool, refusal, and reasoning summary signals.

## 2) Scope

### In scope
- Chat streaming endpoint: `POST /api/v1/chat/stream`
- Workflow streaming endpoint: `POST /api/v1/workflows/{workflow_key}/run-stream`

### Out of scope
- A “debug/raw stream” for operators (server-only traces/logs handle raw fidelity).
- Backwards compatibility (contract-first refactor).

## 3) Key decisions (locked)

- **SSE framing:** data-only SSE everywhere (`data: <json>\n\n`) with optional comment heartbeats.
- **Public payload policy:** derived-only (no `payload`, no `raw_event`, no prompts/instructions/tool configs).
- **Terminal semantics:** exactly one terminal event per stream; terminal kind is either `final` or `error`.
- **Final status enum:** `completed | failed | incomplete | refused | cancelled`
- **Reasoning:** summary-only to browsers (never stream “full reasoning”).
- **Refusal:** first-class UX concept (not coerced into `error`).
- **Function + MCP tool arguments:** visible in UI (`arguments_text` + best-effort `arguments_json`) with redaction/truncation indicators.
- **Chunking:** large fields are streamed via chunk events; semantics are unbounded while frames are bounded.

## 4) Transport (SSE)

### 4.1 Event framing

Each SSE event is a single JSON object emitted as:

```
data: { ...json... }\n\n
```

Comments (heartbeats) may be sent as:

```
: heartbeat 2025-12-15T12:00:00Z\n\n
```

Clients must use a **real SSE parser** (supporting comments and multi-line `data:` blocks), not a `startsWith("data: ")` heuristic.

### 4.2 Content type

- `Content-Type: text/event-stream`
- `Cache-Control: no-cache`
- `Connection: keep-alive`

## 5) Contract versioning

- Every event includes `schema="public_sse_v1"`.
- Any incompatible change must increment `schema` (e.g., `public_sse_v2`) and ship as a coordinated backend+frontend change.

## 6) Common event envelope

All event kinds share this envelope.

### 6.1 Required fields

```json
{
  "schema": "public_sse_v1",
  "event_id": 1,
  "stream_id": "stream_...",
  "server_timestamp": "2025-12-15T12:00:00.000Z",
  "kind": "..."
}
```

### 6.2 Context fields (recommended)

```json
{
  "conversation_id": "uuid",
  "response_id": "resp_...",
  "agent": "triage",
  "workflow": {
    "workflow_key": "analysis_code",
    "workflow_run_id": "run_...",
    "stage_name": "stage-1",
    "step_name": "analysis",
    "step_agent": "researcher",
    "parallel_group": "group-0",
    "branch_index": 0
  }
}
```

- `workflow` is omitted for non-workflow streams.
- Fields may be `null` early in the stream (e.g., `response_id` before the provider assigns it).

### 6.3 Ordering fields

- `event_id` MUST be monotonically increasing within a stream.
- `provider_sequence_number` MAY be present (best-effort) when the source event originates from the provider’s Responses stream.
- `output_index` + `item_id` define **insert/update semantics** for the primary transcript:
  - `output_index` is the stable position of an output item within the provider `response.output[]` array.
  - `item_id` is the stable identifier for that output item (message id, tool-call id, etc.).
  - Clients SHOULD render transcript rows ordered by `output_index`, and apply updates by `item_id` (and `content_index` where applicable).

## 7) Invariants

### 7.1 Terminal invariants

- A stream MUST end with exactly one terminal event:
  - `kind="final"` **or**
  - `kind="error"`
- No events may be emitted after a terminal event.

### 7.2 Safety invariants (derived-only)

Public events MUST NOT include any of:
- prompt/system/developer instructions
- tool configuration objects (e.g., web_search config, vector_store ids list if considered sensitive for your product)
- raw provider objects (`raw_event`, unfiltered `payload`)

### 7.3 Chunking invariants

- Chunk events are used to stream large fields without huge single frames.
- Chunk streams are keyed by a `ChunkTarget`. Completion is signaled by `chunk.done`.

## 8) Redaction / truncation / chunking markers

Any event MAY carry `notices` to support intentional UX messaging:

```json
{
  "notices": [
    {
      "type": "redacted",
      "path": "tool.arguments_json.api_key",
      "message": "Some fields were redacted for safety."
    },
    {
      "type": "truncated",
      "path": "tool.output.results[0].text",
      "message": "Large content was truncated for streaming stability."
    }
  ]
}
```

- `path` uses a dot/bracket path into the event JSON (human readable; not a JSONPointer).
- Redaction/truncation must be **explicit**; the UI should never silently “miss” data.

### 8.1 Default policy (v1 implementation)

These are the current backend defaults used by `PublicStreamProjector` (subject to iteration as product needs evolve):

- **Sensitive key redaction**: object keys whose names contain a sensitive substring (e.g., `api_key`, `authorization`, `token`, `secret`, `password`) are replaced with `"<redacted>"` and emit a `notices[]` entry.
- **Function/MCP arguments**:
  - `arguments_json` string values truncated at **4,000 chars**.
  - `arguments_text` truncated at **8,000 chars**.
- **Function/MCP outputs**: string values truncated at **8,000 chars** (and emit `notices[]` entries).
- **File search**:
  - results list truncated to **10 items**.
  - per-result `text` truncated to **2,000 chars**.
- **Images**:
  - `partial_image_b64` is never emitted inline; it streams via `chunk.delta` events with **~128KiB** chunks.

## 9) Event kinds (v1)

This section is normative. Only these `kind` values are emitted in `public_sse_v1`.

### 9.1 `lifecycle`

Represents high-level response lifecycle for UI progress.

```json
{
  "kind": "lifecycle",
  "status": "queued | in_progress | completed | failed | incomplete | cancelled",
  "reason": "optional string"
}
```

### 9.2 `output_item.added` / `output_item.done`

Insert/update signals for a single output item. Clients create a placeholder row on `output_item.added`,
update it in-place as deltas arrive, and mark it complete on `output_item.done`.

```json
{
  "kind": "output_item.added",
  "output_index": 0,
  "item_id": "item_...",
  "item_type": "function_call | web_search_call | message | ...",
  "role": "assistant",
  "status": "in_progress"
}
```

### 9.3 `message.delta`

Append-only assistant message tokens for a specific output item.

```json
{
  "kind": "message.delta",
  "output_index": 1,
  "item_id": "msg_...",
  "content_index": 0,
  "delta": "text"
}
```

### 9.4 `message.citation`

Citation annotations for a message. `citation.type` matches the OpenAI citation type strings.

```json
{
  "kind": "message.citation",
  "output_index": 1,
  "item_id": "msg_...",
  "content_index": 0,
  "citation": {
    "type": "url_citation",
    "start_index": 10,
    "end_index": 42,
    "title": "Example",
    "url": "https://example.com"
  }
}
```

Supported citation union in v1:
- `url_citation`
- `file_citation`
- `container_file_citation`

### 9.5 `reasoning_summary.delta`

Append-only reasoning summary text deltas (browser-safe).

```json
{
  "kind": "reasoning_summary.delta",
  "output_index": 0,
  "item_id": "rs_...",
  "summary_index": 0,
  "delta": "summary text"
}
```

### 9.6 `refusal.delta` / `refusal.done`

Refusal text is first-class and can stream.

```json
{
  "kind": "refusal.delta",
  "output_index": 1,
  "item_id": "msg_...",
  "content_index": 0,
  "delta": "refusal text so far"
}
```

```json
{
  "kind": "refusal.done",
  "output_index": 1,
  "item_id": "msg_...",
  "content_index": 0,
  "refusal_text": "final refusal"
}
```

### 9.7 `tool.status`

Tool status transitions for hosted tools, function tools, and MCP tools.

```json
{
  "kind": "tool.status",
  "output_index": 0,
  "item_id": "call_...",
  "tool": { "tool_type": "...", "tool_call_id": "...", "status": "..." }
}
```

The `tool` payload is a discriminated union by `tool_type`.

#### Hosted tools (`tool_type`)
- `web_search`
  - status: `in_progress | searching | completed`
  - fields: `query?: string`, `sources?: string[]`
- `file_search`
  - status: `in_progress | searching | completed`
  - fields: `queries?: string[]`, `results?: FileSearchResult[]`
- `code_interpreter`
  - status: `in_progress | interpreting | completed`
  - fields: `container_id?: string`, `container_mode?: "auto" | "explicit"`
- `image_generation`
  - status: `in_progress | generating | partial_image | completed`
  - fields: `revised_prompt?: string`, `format?: string`, `size?: string`, `quality?: string`, `background?: string`

#### Function tools (`tool_type="function"`)
- status: `in_progress | completed | failed`
- fields: `name: string`, `arguments_text?: string`, `arguments_json?: object`, `output?: unknown`

#### MCP tools (`tool_type="mcp"`)
- status: `awaiting_approval | in_progress | completed | failed`
- fields: `server_label?: string`, `tool_name: string`, `arguments_text?: string`, `arguments_json?: object`, `output?: unknown`

### 9.8 `tool.arguments.delta` / `tool.arguments.done`

Streaming tool input for function and MCP calls.

Notes:
- `tool.arguments.delta` is best-effort and may be emitted as **sanitized** deltas (not necessarily 1:1 with provider deltas).
- `tool.arguments.done` is the authoritative “final arguments” payload.

```json
{
  "kind": "tool.arguments.delta",
  "output_index": 0,
  "item_id": "call_...",
  "tool_call_id": "call_...",
  "tool_type": "function | mcp",
  "tool_name": "get_current_time",
  "delta": "{ \"timezone\": \"UTC\""
}
```

```json
{
  "kind": "tool.arguments.done",
  "output_index": 0,
  "item_id": "call_...",
  "tool_call_id": "call_...",
  "tool_type": "function | mcp",
  "tool_name": "get_current_time",
  "arguments_text": "{ \"timezone\": \"UTC\" }",
  "arguments_json": { "timezone": "UTC" }
}
```

### 9.9 `tool.code.delta` / `tool.code.done`

Streaming code snippets for code interpreter calls.

```json
{
  "kind": "tool.code.delta",
  "output_index": 0,
  "item_id": "ci_...",
  "tool_call_id": "ci_...",
  "delta": "print('hello')"
}
```

```json
{
  "kind": "tool.code.done",
  "output_index": 0,
  "item_id": "ci_...",
  "tool_call_id": "ci_...",
  "code": "print('done')"
}
```

### 9.10 `tool.output`

Structured tool outputs (where the UX benefits from explicit outputs rather than relying only on the final assistant message).

```json
{
  "kind": "tool.output",
  "output_index": 0,
  "item_id": "call_...",
  "tool_call_id": "call_...",
  "tool_type": "web_search | file_search | code_interpreter | image_generation | function | mcp",
  "output": { "any": "json" }
}
```

### 9.11 `chunk.delta` / `chunk.done`

Chunk events stream large fields without giant frames (e.g., base64 partial image updates).

#### Chunk target

```json
{
  "entity_kind": "tool_call | message",
  "entity_id": "id",
  "field": "partial_image_b64",
  "part_index": 0
}
```

#### Chunk delta

```json
{
  "kind": "chunk.delta",
  "output_index": 0,
  "item_id": "img_...",
  "target": { "entity_kind": "tool_call", "entity_id": "img_...", "field": "partial_image_b64", "part_index": 0 },
  "encoding": "base64",
  "chunk_index": 0,
  "data": "AAAA..."
}
```

#### Chunk done

```json
{
  "kind": "chunk.done",
  "output_index": 0,
  "item_id": "img_...",
  "target": { "entity_kind": "tool_call", "entity_id": "img_...", "field": "partial_image_b64", "part_index": 0 }
}
```

### 9.12 `error` (terminal)

Terminal event for failures where a structured `final` summary cannot be produced.

```json
{
  "kind": "error",
  "error": {
    "code": "optional",
    "message": "human readable",
    "source": "provider | server",
    "is_retryable": false
  }
}
```

### 9.13 `final` (terminal)

Terminal event for all non-exceptional endings (including refusals/incomplete).

```json
{
  "kind": "final",
  "final": {
    "status": "completed | failed | incomplete | refused | cancelled",
    "response_text": "optional string",
    "structured_output": null,
    "reasoning_summary_text": "optional string",
    "refusal_text": "optional string",
    "attachments": [
      { "object_id": "obj_...", "filename": "image.png", "mime_type": "image/png", "url": "https://..." }
    ],
    "usage": { "input_tokens": 123, "output_tokens": 456, "total_tokens": 579 }
  }
}
```

## 10) Mapping (OpenAI → Public Contract)

This mapping is informational (not part of the public wire format) to keep the contract aligned with the Responses API reference.

| Source (Responses API / Agents SDK) | Public event(s) |
| --- | --- |
| `response.output_item.added` / `response.output_item.done` | `output_item.added` / `output_item.done` |
| `response.output_text.delta` | `message.delta` |
| `response.output_text.annotation.added` (citations) | `message.citation` |
| `response.reasoning_summary_text.delta` / `*.done` | `reasoning_summary.delta` (+ final `reasoning_summary_text`) |
| `response.refusal.delta` / `response.refusal.done` | `refusal.delta` / `refusal.done` (+ final `refusal_text`) |
| hosted tool status events | `tool.status` |
| `response.code_interpreter_call_code.delta` / `*.done` | `tool.code.delta` / `tool.code.done` |
| `response.function_call_arguments.*` / `response.mcp_call_arguments.*` | `tool.arguments.delta` / `tool.arguments.done` |
| SDK `run_item_stream_event` (`tool_output`) | `tool.output` (when useful) |
| provider `type="error"` or server exception | terminal `error` or `final.status="failed"` depending on availability of structured final summary |

## 11) Examples

Examples are stored as NDJSON (one JSON event per line):

- `docs/contracts/public-sse-streaming/examples/chat-web-search.ndjson`
- `docs/contracts/public-sse-streaming/examples/chat-code-interpreter.ndjson`
- `docs/contracts/public-sse-streaming/examples/chat-file-search.ndjson`
- `docs/contracts/public-sse-streaming/examples/chat-function-tool.ndjson`
- `docs/contracts/public-sse-streaming/examples/chat-image-generation-partials.ndjson`
- `docs/contracts/public-sse-streaming/examples/chat-mcp-tool.ndjson`
- `docs/contracts/public-sse-streaming/examples/chat-refusal.ndjson`
- `docs/contracts/public-sse-streaming/examples/chat-reasoning-summary.ndjson`
- `docs/contracts/public-sse-streaming/examples/chat-provider-error.ndjson`
- `docs/contracts/public-sse-streaming/examples/workflow-analysis-code.ndjson`
