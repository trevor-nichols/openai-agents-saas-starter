# JWT Consumer Matrix (Draft)

**Status:** In Review  
**Last Updated:** 2025-11-06  
**Purpose:** Enumerate every current and near-term consumer of Ed25519-signed JWTs so audiences, claims, and operational constraints are finalized ahead of AUTH-002.

| Service / Surface | Owner | Environments | JWT Audience | Required Claims | Edge Constraints / Notes | Status |
| --- | --- | --- | --- | --- | --- | --- |
| FastAPI `/api/v1/billing` routers (tenant billing, subscriptions) | Backend Platform · Billing Pod | dev, staging, production | `agent-api` (shared) | `iss=settings.auth_issuer`; `aud` contains `agent-api`; `sub` (user/device); `tenant_id`; `scope` ⊇ `billing:*`; `token_use=access`; `jti`; `nbf`, `exp` | TenantContext derives tenant from token; verification must stay <50 ms p95; JWKS cached locally ≤5 min; Redis revocation fallback to Postgres | Confirmed |
| FastAPI `/api/v1/auth/refresh` endpoint | Backend Platform · Auth Pod | dev, staging, production | `agent-api` (refresh) | `iss`; `aud`; `sub`; `token_use=refresh`; `jti`; `tenant_id`; `device_fingerprint_hash`; `nbf`, `exp` | Requires hashed fingerprint binding; detects replay via revocation store; must complete within 100 ms to avoid frontend UX lag | Confirmed |
| FastAPI `/api/v1/agents`, `/chat`, `/conversations`, `/tools` routers (post-AUTH-003 enforcement) | Backend Platform · Agent Experience Pod | dev, staging, production | `agent-api` | `iss`; `aud`; `sub`; `tenant_id`; `scope` ⊇ `agents:read`, `chat:invoke`, `conversations:read` (final scopes TBD); `token_use=access`; `jti`; `exp` | Currently unauthenticated; will shift to `require_current_user` once AuthService lands. **GAP:** finalize scope taxonomy + per-route enforcement plan | Planned |
| Next.js Agent Dashboard client | Frontend Web Pod | dev (localhost), staging, production | Consumes `agent-api` tokens; no direct verification today | Needs `tenant_id`, `scope` for feature gating; reads `exp` for silent refresh; `token_use=access` | Stores access token in memory; refresh via HTTP-only cookie or withheld entirely until final flow defined per architecture blueprint §9. Optional JWKS introspection if offline mode enabled. **GAP:** confirm whether client-side JWKS introspection is needed | Planned |
| Analytics batch jobs & scheduled ETL (nightly conversation exports) | Data Insights Team | staging analytics, prod analytics | `analytics-service` (proposed) | `iss`; `aud` contains `analytics-service`; `sub` = service account; `scope` ⊇ `analytics:read`; `token_use=access`; `exp` (longer TTL) | Jobs run in VPC without outbound internet; JWKS cached on job start; tolerate ≤5 min JWKS staleness. **GAP:** define issuance channel (service account or token exchange) | Planned |
| Billing reconciliation workers / Stripe webhook forwarder | Backend Platform · Billing Pod | staging ops, prod ops | `billing-worker` (proposed) | `iss`; `aud` contains `billing-worker`; `sub` = worker id; `scope` ⊇ `billing:sync`; `token_use=access`; `jti`; `exp` | Worker validates tokens on inbound webhook replay checks. Requires idempotent revocation lookups; latency not critical (<250 ms). **GAP:** confirm whether Stripe events will leverage JWT or HMAC | Planned |
| Support & Ops console (internal tooling) | Customer Ops Team | staging, production | `support-console` (proposed) | `iss`; `aud` contains `support-console`; `sub` = agent id; `scope` ⊇ `support:*`; `tenant_id` optional (cross-tenant read); `token_use=access`; `exp` | Requires elevated auditing; JWKS cached via CDN; tokens fetched through SSO integration. **GAP:** decide on per-tenant override vs. global tenant scope handling | Planned |
| Automated load testing / synthetic monitors | SRE / Reliability | staging, production | `synthetic-monitor` (proposed) | `iss`; `aud` contains `synthetic-monitor`; `sub` = monitor id; `scope` limited (`health:read`, `chat:invoke`); `token_use=access`; `exp` short (≤5 min) | Tokens provisioned via service account; monitors run continuously (≤30 s intervals). Need lightweight cache and prompt revocation on canary failure | Planned |

## Open Questions / Follow-ups
- Finalize audience identifiers (`auth_audience`) per non-API consumer (`analytics-service`, `billing-worker`, `support-console`, `synthetic-monitor`).  
- Define scope taxonomy for non-billing routers (agents/chat/conversations/tools) and document mapping in AuthService.  
- Confirm frontend refresh-token storage pattern (HTTP-only cookie vs. withheld) and whether client-side JWKS introspection is required.  
- Determine token provisioning mechanism for analytics, billing workers, support console, and synthetic monitors (service-account issuance vs. STS exchange).  
- Validate whether Stripe webhook pipeline needs JWT verification or continues using HMAC-only model.
