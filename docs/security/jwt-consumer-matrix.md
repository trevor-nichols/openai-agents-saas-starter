# JWT Consumer Matrix (Draft)

**Status:** In Review  
**Last Updated:** 2025-11-06  
**Purpose:** Enumerate every current and near-term consumer of Ed25519-signed JWTs so audiences, claims, and operational constraints are finalized ahead of AUTH-002.

| Service / Surface | Owner | Environments | JWT Audience | Required Claims | Edge Constraints / Notes | Status |
| --- | --- | --- | --- | --- | --- | --- |
| FastAPI `/api/v1/billing` routers (tenant billing, subscriptions) | Backend Platform · Billing Pod | dev, staging, production | `agent-api` | `iss=settings.auth_issuer`; `aud` contains `agent-api`; `sub` (user/device); `tenant_id`; `scope` includes `billing:read` (GET) or `billing:manage` (mutations); `token_use=access`; `jti`; `nbf`, `exp` | TenantContext derives tenant from token; verification must stay <50 ms p95; JWKS cached locally ≤5 min; Redis revocation fallback to Postgres | Confirmed |
| FastAPI `/api/v1/auth/refresh` endpoint | Backend Platform · Auth Pod | dev, staging, production | `agent-api` | `iss`; `aud`; `sub`; `token_use=refresh`; `jti`; `tenant_id`; `device_fingerprint_hash`; `nbf`, `exp` | Requires hashed fingerprint binding; detects replay via revocation store; must complete within 100 ms to avoid frontend UX lag | Confirmed |
| FastAPI `/api/v1/agents`, `/chat`, `/conversations`, `/tools` routers (post-AUTH-003 enforcement) | Backend Platform · Agent Experience Pod | dev, staging, production | `agent-api` | `iss`; `aud`; `sub`; `tenant_id`; `scope` includes `conversations:read` (GET history), `conversations:write` (chat/send), `conversations:delete` (purge), `tools:read` (catalog); `token_use=access`; `jti`; `exp` | Enforcement plan: wire `require_current_user` with scope checks once AuthService ships; read-only endpoints gate on `conversations:read`/`tools:read`, mutations on `conversations:write` or `conversations:delete`. | Planned |
| Next.js Agent Dashboard client | Frontend Web Pod | dev (localhost), staging, production | `agent-api` | Needs `tenant_id`, `scope` for feature gating; reads `exp` for silent refresh; `token_use=access` | Stores access token in memory; refresh tokens delivered exclusively via secure, HTTP-only, SameSite=Strict cookies; no client-side JWKS introspection in v1. | Planned |
| Analytics batch jobs & scheduled ETL (nightly conversation exports) | Data Insights Team | staging analytics, prod analytics | `analytics-service` | `iss`; `aud` contains `analytics-service`; `sub` = service account; `scope` includes `conversations:read`; `token_use=access`; `exp` (longer TTL) | Service accounts obtain tenant-scoped refresh tokens via AuthService CLI helper (Vault-backed credential); jobs exchange for access tokens before runs; JWKS cached per job start (≤5 min staleness). | Planned |
| Billing reconciliation workers / Stripe webhook forwarder | Backend Platform · Billing Pod | staging ops, prod ops | `billing-worker` | `iss`; `aud` contains `billing-worker`; `sub` = worker id; `scope` includes `billing:read`, `billing:manage`; `token_use=access`; `jti`; `exp` | Stripe inbound webhooks remain HMAC-verified; workers consume JWTs only when calling internal APIs. Service-account issuance via AuthService CLI helper; revocation latency tolerates <250 ms. | Planned |
| Support & Ops console (internal tooling) | Customer Ops Team | staging, production | `support-console` | `iss`; `aud` contains `support-console`; `sub` = agent id; `scope` = `support:*`; `tenant_id` optional (cross-tenant read); `token_use=access`; `exp` | Tokens provisioned through managed service accounts in Vault; console enforces `support:*` for privileged operations; JWKS cached via CDN. | Planned |
| Automated load testing / synthetic monitors | SRE / Reliability | staging, production | `synthetic-monitor` | `iss`; `aud` contains `synthetic-monitor`; `sub` = monitor id; `scope` includes `conversations:write` (chat probes), `tools:read` (catalog validation), `billing:read` (optional health); `token_use=access`; `exp` short (≤5 min) | Service accounts mint refresh tokens via CLI helper; monitors rotate access tokens hourly; cache JWKS locally; prioritize lightweight revocation cache to revoke failing canaries. | Planned |

## Enforcement & Provisioning Summary
- Audience identifiers locked: `agent-api`, `analytics-service`, `billing-worker`, `support-console`, `synthetic-monitor`. Update `auth_audience` defaults in settings to mirror this list.  
- Scope taxonomy applied per surface: billing (`billing:read`/`billing:manage`), conversations/chat (`conversations:*`), tools catalog (`tools:read`), internal console (`support:*`).  
- Non-interactive consumers receive tenant-scoped refresh tokens from AuthService using managed service-account credentials in Vault; helper CLI/CI workflow issues tokens without STS exchange.  
- Stripe webhook verification stays HMAC-based; JWT usage confined to internal API calls by billing workers.
